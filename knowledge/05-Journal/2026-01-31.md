---
created: 2026-01-31
tags: [journal, phase/refactoring]
---

# 2026-01-31: Umfassendes Code-Refactoring (Phase 6)

## Ziel

Vollstaendiges Refactoring des gesamten Projekts fuer:
- **Wartbarkeit**: Klare Struktur, keine Duplikationen
- **Konsistenz**: Einheitliche Patterns, Error Handling, Logging
- **Funktionalitaet**: Alle Features funktionieren korrekt
- **Nachvollziehbarkeit**: Gut dokumentierter, lesbarer Code

---

## Durchgeführte Aktivitäten

### Phase 1: CSS-Refactoring

**Problem:** ~500 Zeilen Inline-CSS in index.html, Duplikationen zwischen Dateien

**Loesung:**
- Neue Datei `docs/css/toolbar.css` mit allen Toolbar-Styles
- Neue Datei `docs/css/dashboard.css` mit Chart/Dashboard-Styles
- Inline-Styles durch CSS-Klassen ersetzt (z.B. `.toolbar__group--hidden`)
- index.html von ~615 auf ~335 Zeilen reduziert

### Phase 2: JavaScript Utility-Funktionen zentralisieren

**Problem:** `getColorForUni()` in 4+ Dateien dupliziert

**Loesung:**

```
docs/js/utils/
├── colorUtils.js    # Zentrale Farbverwaltung
└── formatUtils.js   # Formatierungsfunktionen
```

**colorUtils.js:**
```javascript
export function getUniColor(uni) { ... }
export function getUniColorWithAlpha(uni, alpha) { ... }
```

**formatUtils.js:**
```javascript
export function formatValue(value, unit, options) { ... }
export function formatTrend(percent, options) { ... }
export function formatCompact(value, options) { ... }
export function formatDate(date, options) { ... }
export function formatRatio(value, options) { ... }
```

Alle Visualisierungen nutzen jetzt diese zentralen Funktionen.

### Phase 3: State Management verbessern

**Probleme:**
- Keine State-Validierung (ungueltige Werte wurden akzeptiert)
- Bug: Division durch 0 in `calculateStats()`
- Keine Batch-Updates

**Loesungen:**

**State-Validatoren hinzugefuegt:**
```javascript
const STATE_VALIDATORS = {
    selectedUniversities: (val) => Array.isArray(val),
    yearRange: (val) => val && val.start >= 2019 && val.end <= 2030,
    selectedKennzahl: (val) => typeof val === 'string',
    combinationType: (val) => val === null ||
        ['dualAxis', 'ratio', 'scatter'].includes(val),
    // ...
};
```

**Bug-Fix fuer Division durch 0:**
```javascript
// VORHER (BUG)
trend = ((lastAvg - firstAvg) / firstAvg) * 100;

// NACHHER (FIX)
if (firstAvg !== 0) {
    trend = ((lastAvg - firstAvg) / firstAvg) * 100;
} else if (lastAvg > 0) {
    trend = 100;
} else {
    trend = 0;
}
```

**Batch-Updates fuer Performance:**
```javascript
batch(updates) {
    this.isBatching = true;
    Object.entries(updates).forEach(([key, value]) => { ... });
    this.isBatching = false;
    // Alle Subscriber gleichzeitig benachrichtigen
}
```

### Phase 4: Event-System optimieren

**Probleme:**
- Keine Event-Debouncing (FILTER_CHANGE konnte sehr haeufig feuern)
- Kein Event-Logging im Debug-Modus

**Loesungen:**

```javascript
// eventBus.js
emitDebounced(event, data, delay = 100) {
    if (this.debounceTimers.has(event)) {
        clearTimeout(this.debounceTimers.get(event));
    }
    const timer = setTimeout(() => {
        this.emit(event, data);
    }, delay);
    this.debounceTimers.set(event, timer);
}
```

Debug-Logging hinzugefuegt mit `log.debug()`.

### Phase 5: Router-Validierung

**Problem:** Ungueltige URL-Parameter konnten State korrumpieren

**Loesung:**
```javascript
// Nur gueltige Uni-Codes akzeptieren
const validUnis = unis.split(',')
    .map(u => u.trim())
    .filter(u => UNI_BY_CODE[u]);

// Nur bekannte Kennzahlen akzeptieren
if (kennzahl && KENNZAHL_BY_CODE[kennzahl]) {
    state.set('selectedKennzahl', kennzahl);
}

// Jahresbereich validieren und korrigieren
const validStart = Math.max(2019, Math.min(2024, start));
const validEnd = Math.max(validStart, Math.min(2024, end));
```

### Phase 6: Komponenten-Fehlerbehandlung

- Einheitliches Error-Pattern in allen Komponenten
- `log.error()` statt `console.error()`
- Zentrale `colorUtils` in allen Visualisierungen

### Phase 7: HTML-Bereinigung + Toolbar-Komponente

**Problem:** ~280 Zeilen Inline-Script in index.html

**Loesung:** Neue Komponente `docs/js/components/Toolbar.js`

```javascript
class Toolbar {
    constructor() {
        this.elements = {};
        this.init();
    }

    init() {
        this.cacheElements();
        this.initKennzahlSelectors();
        this.initDualModeControls();
        this.initOutputTabs();
        this.initVizTypeButtons();
        this.initShareButton();
        this.initStatsDisplay();
        this.restoreFromState();
    }
    // ... ~330 Zeilen sauberer Code
}

export function initToolbar() { ... }
```

### Phase 8: Python-Scripts konsolidieren

**Problem:** Mehrere aehnliche Konverter-Scripts

**Loesung:** Neues unified `scripts/convert.py`

```python
class WissensbilanzConverter:
    VALID_UNI_CODES = {...}
    VALID_YEARS = range(2019, 2025)

    def convert_all(self):
        for excel_file in Path(self.input_dir).glob('*.xlsx'):
            output = self.convert_file(excel_file)
            self.validate_and_save(output)

    def validate_data_point(self, entry):
        # Validiere alle Eintraege
```

Features:
- `--validate` Flag fuer Output-Verifikation
- Automatische Encoding-Erkennung
- Konsistente Fehlerbehandlung

### Phase 9: Neue Dual-Mode Visualisierungen

Zwei neue Chart-Typen fuer Kennzahl-Kombinationen:

**DualAxisChart.js:**
- Zwei Kennzahlen mit zwei Y-Achsen
- Primaer: Durchgezogene Linien (linke Y-Achse)
- Sekundaer: Gestrichelte Linien (rechte Y-Achse)

**ScatterChart.js:**
- Korrelationsanalyse zwischen zwei Kennzahlen
- Pearson-Korrelationskoeffizient berechnet
- Trendlinie optional einblendbar
- Punkte nach Uni-Typ gefaerbt

---

## Entscheidungen

| Entscheidung | Begründung |
|--------------|------------|
| Zentrale colorUtils | DRY-Prinzip, Konsistenz |
| State-Validatoren | Robustheit, Debugging |
| Batch-Updates | Performance bei vielen Aenderungen |
| Event-Debouncing | Verhindert UI-Flackern |
| URL-Validierung | Fehlertoleranz bei manuellen URLs |
| Toolbar-Komponente | Separation of Concerns |
| Unified Python-Converter | Wartbarkeit, Konsistenz |

---

## Statistik

| Metrik | Vorher | Nachher |
|--------|--------|---------|
| index.html Zeilen | ~615 | ~335 |
| Inline CSS | ~500 Zeilen | 0 |
| Inline JS | ~280 Zeilen | 0 |
| colorUtils Duplikate | 4+ | 1 (zentral) |
| State-Validierung | keine | vollstaendig |
| Neue Dateien | - | 7 |

**Neue Dateien:**
1. `docs/css/toolbar.css`
2. `docs/css/dashboard.css`
3. `docs/js/utils/colorUtils.js`
4. `docs/js/utils/formatUtils.js`
5. `docs/js/components/Toolbar.js`
6. `docs/js/visualizations/DualAxisChart.js`
7. `docs/js/visualizations/ScatterChart.js`
8. `scripts/convert.py`

---

## Commit

```
refactor: Comprehensive codebase refactoring (Phase 1-9)

Phase 1: CSS - Extract inline styles to toolbar.css, dashboard.css
Phase 2: Utils - Centralize colorUtils.js, formatUtils.js
Phase 3: State - Add validators, fix div/0 bug, add batch()
Phase 4: EventBus - Add emitDebounced(), debug logging
Phase 5: Router - Add URL parameter validation
Phase 6: Components - Consistent error handling
Phase 7: HTML - Extract Toolbar.js component (~280 lines)
Phase 8: Python - Unified convert.py with validation
Phase 9: Viz - Add DualAxisChart, ScatterChart

24 files changed, 3080 insertions(+), 573 deletions(-)
```

---

## Nächste Schritte

### Abgeschlossen
- [x] CSS-Refactoring (Phase 1)
- [x] Utility-Funktionen zentralisieren (Phase 2)
- [x] State-Verbesserungen (Phase 3)
- [x] EventBus-Optimierung (Phase 4)
- [x] Router-Validierung (Phase 5)
- [x] Komponenten-Fehler (Phase 6)
- [x] HTML-Bereinigung (Phase 7)
- [x] Python-Konsolidierung (Phase 8)
- [x] Dual-Mode Visualisierungen (Phase 9)
- [x] Dokumentation aktualisieren

### Offen
- [ ] Extended Views vollstaendig testen
- [ ] Hypothesen H1-H4 validieren
- [ ] End-to-End Tests fuer alle Visualisierungen

---

*Learnings: Konsequentes Refactoring verbessert Wartbarkeit signifikant. Zentrale Utilities reduzieren Fehlerquellen. State-Validierung macht Debugging einfacher.*
